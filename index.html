<script>
    const gDriveApikey = "AIzaSyAIpSmdpo48g_EK9kQdcuDKEYJtyqNEGAU"; // Reemplaza con tu clave de API

    function isValidUrl(url) {
        try {
            new URL(url);
            return true;
        } catch (e) {
            return false;
        }
    }

    function extractGoogleDriveId(url) {
        const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        return match ? match[1] : null;
    }

    async function getGoogleDriveFileUrl(fileId) {
        const apiUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${gDriveApikey}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error("Error al acceder al archivo. Asegúrate de que el archivo sea público.");
            }
            return apiUrl;
        } catch (error) {
            alert(error.message);
            return null;
        }
    }

    function addSubtitleField() {
        const container = document.getElementById('subtitle-fields');
        const fieldIndex = container.children.length + 1;

        const subtitleField = document.createElement('div');
        subtitleField.innerHTML = `
            <label for="subtitle-${fieldIndex}">Subtítulo ${fieldIndex} (URL o ID):</label>
            <input type="text" id="subtitle-${fieldIndex}" placeholder="Ejemplo: https://drive.google.com/file/d/FILE_ID/view">
            <label for="subtitle-lang-${fieldIndex}">Idioma (${fieldIndex}):</label>
            <input type="text" id="subtitle-lang-${fieldIndex}" placeholder="es, en, fr...">
        `;
        container.appendChild(subtitleField);
    }

    async function generateIframe() {
        const service = document.getElementById('service').value;
        const videoInput = document.getElementById('video-id').value.trim();
        const posterUrl = document.getElementById('poster-url').value.trim();

        let videoUrl;

        if (service === "direct") {
            videoUrl = videoInput;
        } else if (service === "pixeldrain") {
            videoUrl = `https://pixeldrain.com/api/file/${videoInput}`;
        } else if (service === "googledrive") {
            if (videoInput.startsWith("https://drive.google.com")) {
                const fileId = extractGoogleDriveId(videoInput);
                if (!fileId) {
                    alert("Enlace de Google Drive no válido.");
                    return;
                }
                videoUrl = await getGoogleDriveFileUrl(fileId);
            } else {
                videoUrl = await getGoogleDriveFileUrl(videoInput);
            }
        }

        if (!videoInput || !videoUrl) {
            alert("Por favor, ingresa un ID/URL válido.");
            return;
        }

        if ((service === "direct" && !isValidUrl(videoUrl)) || (posterUrl && !isValidUrl(posterUrl))) {
            alert("Por favor, ingresa URLs válidas.");
            return;
        }

        // Obtener subtítulos
        const subtitleFields = document.querySelectorAll('#subtitle-fields input[type="text"]');
        const subtitles = [];
        for (let i = 0; i < subtitleFields.length; i += 2) {
            const subtitleUrl = subtitleFields[i].value.trim();
            const subtitleLang = subtitleFields[i + 1].value.trim();
            if (subtitleUrl && subtitleLang) {
                if (subtitleUrl.startsWith("https://drive.google.com")) {
                    const fileId = extractGoogleDriveId(subtitleUrl);
                    if (fileId) {
                        subtitles.push({
                            url: `https://drive.google.com/uc?export=download&id=${fileId}`,
                            lang: subtitleLang
                        });
                    }
                } else {
                    subtitles.push({
                        url: subtitleUrl,
                        lang: subtitleLang
                    });
                }
            }
        }

        // Generar URL del iframe
        const queryParams = new URLSearchParams();
        queryParams.set('video', videoUrl);
        if (posterUrl) queryParams.set('poster', posterUrl);
        subtitles.forEach((subtitle, index) => {
            queryParams.set(`subtitle${index + 1}`, subtitle.url);
            queryParams.set(`subtitle${index + 1}-lang`, subtitle.lang);
        });

        const iframeSrc = `https://jeison-ramos.github.io/player/player.html?${queryParams.toString()}`;

        // Mostrar el iframe generado
        const iframePreview = document.getElementById('iframe-preview');
        iframePreview.innerHTML = `
            <h2>Iframe Generado:</h2>
            <textarea rows="4" style="width: 100%;">${`<iframe src="${iframeSrc}" width="800" height="450" frameborder="0" allowfullscreen></iframe>`}</textarea>
            <h3>Vista Previa:</h3>
            <iframe src="${iframeSrc}" width="800" height="450" frameborder="0" allowfullscreen></iframe>
        `;
    }
</script>
