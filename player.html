<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Plyr con Anuncios VAST</title>
    <!-- Estilos de Plyr -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        .plyr {
            width: 80%;
            max-width: 800px;
            height: 450px;
        }
    </style>
</head>
<body>
    <!-- Contenedor del video -->
    <video id="player" class="plyr" controls playsinline>
        <source src="" type="video/mp4" />
    </video>

    <!-- Script de Plyr -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <!-- Script de Google IMA SDK -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script>
        // Obtener parámetros de la URL
        const params = new URLSearchParams(window.location.search);
        const videoUrl = params.get('video') || '';
        const posterUrl = params.get('poster') || '';

        // Elementos del DOM
        const playerElement = document.getElementById('player');
        playerElement.src = videoUrl;
        if (posterUrl) {
            playerElement.poster = posterUrl;
        }

        // Inicializar Plyr
        const player = new Plyr('#player', {
            controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
        });

        // Configuración de Google IMA SDK
        let adsLoader;
        let adsManager;

        function initIMA() {
            // Crear AdsLoader
            adsLoader = new google.ima.AdsLoader(playerElement);

            // Escuchar eventos de anuncios
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false
            );
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false
            );

            // Solicitar anuncios
            const adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = 'https://thusizulu.com/d/mZFiz.d/GxN/v/ZAGrUI/TeamE9LuXZ/UZl/kLP/T-YYxJNmzMMC3KMIzFAVt-N/jzEa3mMpzncVzOMEQQ'; // Reemplaza con tu URL de VAST
            adsRequest.linearAdSlotWidth = 640;
            adsRequest.linearAdSlotHeight = 480;

            adsLoader.requestAds(adsRequest);
        }

        function onAdsManagerLoaded(adsManagerLoadedEvent) {
            // Inicializar AdsManager
            adsManager = adsManagerLoadedEvent.getAdsManager(playerElement);

            // Escuchar eventos del AdsManager
            adsManager.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError
            );
            adsManager.addEventListener(
                google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,
                onContentPauseRequested
            );
            adsManager.addEventListener(
                google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
                onContentResumeRequested
            );

            try {
                // Iniciar la reproducción de anuncios
                adsManager.init(640, 480, google.ima.ViewMode.NORMAL);
                adsManager.start();
            } catch (error) {
                console.error('Error al iniciar AdsManager:', error);
            }
        }

        function onAdError(adErrorEvent) {
            console.error('Error de anuncio:', adErrorEvent.getError());
            adsManager && adsManager.destroy();
        }

        function onContentPauseRequested() {
            player.pause();
        }

        function onContentResumeRequested() {
            player.play();
        }

        // Inicializar el reproductor
        player.on('ready', () => {
            initIMA();
        });

        // Mostrar error si el video no carga
        player.on('error', () => {
            const errorDiv = document.createElement('div');
            errorDiv.style.color = 'white';
            errorDiv.style.textAlign = 'center';
            errorDiv.style.fontSize = '1.5em';
            errorDiv.textContent = 'Error al cargar el video. Verifica la URL.';
            document.body.appendChild(errorDiv);
        });
    </script>
</body>
</html>
